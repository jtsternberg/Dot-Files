#!/usr/bin/env php
<?php
/**
 * Generates a path vars scripts for wplocal alias to run in LocalWP site shell mode.
 * Used by wplocal: https://github.com/jtsternberg/Dot-Files/blob/master/bin/wplocal
 */

// Try to find the corresponding LocalWP site shell script for the current working directory.
$scriptPath  = getScriptForPath();
if ( empty( $scriptPath ) ) {
	// Ok, just get the most recently edited LocalWP site shell script.
	$scriptPath  = getMostRecentScript();
}

// Clean up the contents to just the bare minimum.
$contents = filteredFileContents( $scriptPath, function( $line ) {

	// Trim whitespace.
	$line = trim( $line );

	// Remove content output, comments, executions, etc.
	foreach ( [
		'echo ',
		'# ',
		'cd ',
		'exec ',
	] as $key ) {
		if ( 0 === strpos( $line, $key ) ) {
			return false;
		}
	}

	return ! empty( $line ) ? $line : false;
} );

// Save content to a tmp file.
$tmpFile = sys_get_temp_dir() . '/' . basename( $scriptPath );
file_put_contents( $tmpFile, $contents );

// Make tmp file executable.
`chmod 755 $tmpFile`;

// Return the file name.
echo $tmpFile;
exit(0);

// Try to find the corresponding LocalWP site shell script for the current working directory.
function getScriptForPath() {
	$home        = $_SERVER['HOME'];
	$contents = file_get_contents( "{$home}/Library/ApplicationSupport/Local/sites.json" );
	if ( empty( $contents ) ) {
		return false;
	}

	$sites = @json_decode( $contents, true );

	if ( empty( $sites ) ) {
		return false;
	}

	$normalizePath = fn( $path ) => explode( '/app/', str_replace( $home, '~', $path ) )[0];

	$dir = $normalizePath( getcwd() );
	foreach ( $sites as $siteId => $site ) {
		$path = $normalizePath( $site['path'] ?? '' );
		if ( $dir === ( $path ?? '' ) ) {
			$scriptPath = "{$home}/Library/ApplicationSupport/Local/ssh-entry/{$siteId}.sh";

			if ( ! file_exists( $scriptPath ) ) {
				echo 'Error: Missing LocalWP script: '. $scriptPath .'. Run "Open site shell" for this site to generate the script before running this command';
				exit(1);
			}

			return $scriptPath;
		}
	}

	return false;
}

// Gets the most recently edited LocalWP site shell script.
function getMostRecentScript() {
	$home        = $_SERVER['HOME'];
	$scriptsPath = "{$home}/Library/ApplicationSupport/Local/ssh-entry";

	// Get the most recent .sh file generated by LocalWP.
	$scripts  = getDirFiles( $scriptsPath, 'sh' );
	$fileName = end( $scripts );

	return "$scriptsPath/$fileName";
}

// Get files of type w/in a directory.
function getDirFiles( $dir, $type = '' ) {
	$files = array();
	$dir = new DirectoryIterator( $dir );
	foreach ( $dir as $fileinfo ) {
		if ( ! $type || $type === $fileinfo->getExtension() ) {
	   	$files[ $fileinfo->getMTime() ] = $fileinfo->getFilename();
		}
	}

	ksort( $files );

	return $files;
}

// Fetches file contents and filters the rows by callback.
function filteredFileContents( $file, $filterCb ) {
	$handle = @fopen( $file, "r" );
	$lines = [];
	if ( ! empty( $handle ) ) {
		while ( ( $line = fgets( $handle ) ) !== false ) {
			$line = $filterCb( $line );
			if ( false !== $line ) {
				$lines[] = $line;
			}
		}

		fclose($handle);
	}

	return implode( "\n", $lines );
}